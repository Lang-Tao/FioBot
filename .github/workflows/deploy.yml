name: Deploy to Aliyun

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Copy files via SCP
              uses: appleboy/scp-action@master
              with:
                  host: ${{ secrets.ALIYUN_HOST }}
                  username: ${{ secrets.ALIYUN_USER }}
                  key: ${{ secrets.ALIYUN_KEY }}
                  source: "."
                  target: "/root/fiobot"
                  # æŽ’é™¤ä¸éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶å’Œç›®å½•ï¼ŒåŠ å¿«é€Ÿåº¦
                  rm: false # ä¸åˆ é™¤ç›®æ ‡ç›®å½•ä¸­çš„çŽ°æœ‰æ–‡ä»¶ï¼Œåªè¦†ç›–
                  strip_components: 0

            - name: Deploy using SSH
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.ALIYUN_HOST }}
                  username: ${{ secrets.ALIYUN_USER }}
                  key: ${{ secrets.ALIYUN_KEY }}
                  script: |
                      # è®¾ç½®é”™è¯¯å¤„ç†
                      set -e

                      echo "ðŸš€ Starting deployment tasks..."

                      # 1. è¿›å…¥å·¥ä½œç›®å½•
                      TARGET_DIR="/root/fiobot"
                      cd $TARGET_DIR

                      # 2. (å·²é€šè¿‡ SCP ä¸Šä¼ ä»£ç ï¼Œæ— éœ€ git pull)
                      echo "âœ… Code updated via SCP."

                      # 3. å®‰è£…ä¾èµ–
                      echo "ðŸ“¦ Checking dependencies..."
                      if [ -f "requirements.txt" ]; then
                          echo "Found requirements.txt, installing..."
                          pip install -r requirements.txt
                      elif [ -f "pyproject.toml" ]; then
                          echo "Found pyproject.toml, installing..."
                          pip install .
                      else
                          echo "âš ï¸ No dependency file found, skipping installation."
                      fi

                      # 4. é‡å¯æœåŠ¡
                      echo "ðŸ”„ Restarting application..."

                      # å‡è®¾ä½¿ç”¨ systemd ç®¡ç†æœåŠ¡ï¼ŒæœåŠ¡åä¸º fiobot
                      if systemctl list-units --full -all | grep -Fq "fiobot.service"; then
                          systemctl restart fiobot
                          echo "âœ… Systemd service 'fiobot' restarted."
                      else
                          echo "âš ï¸ Systemd service 'fiobot' not found."
                          # å¦‚æžœä½¿ç”¨ nohup æ–¹å¼ï¼Œè¯·å–æ¶ˆæ³¨é‡Šä»¥ä¸‹è¡Œï¼š
                          # pkill -f "python bot.py" || true
                          # nohup python bot.py > bot.log 2>&1 &
                      fi

                      echo "ðŸŽ‰ Deployment completed successfully!"
