name: Deploy to Aliyun

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Deploy using SSH
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.ALIYUN_HOST }}
                  username: ${{ secrets.ALIYUN_USER }}
                  key: ${{ secrets.ALIYUN_KEY }}
                  script: |
                      # è®¾ç½®é”™è¯¯å¤„ç†ï¼Œä»»ä½•å‘½ä»¤å¤±è´¥åˆ™åœæ­¢
                      set -e

                      echo "ğŸš€ Starting deployment..."

                      # 1. è¿›å…¥å·¥ä½œç›®å½•
                      TARGET_DIR="/root/fiobot"
                      if [ ! -d "$TARGET_DIR" ]; then
                        echo "âŒ Directory $TARGET_DIR does not exist!"
                        exit 1
                      fi
                      cd $TARGET_DIR

                      # 2. æ‹‰å–æœ€æ–°ä»£ç 
                      echo "ğŸ“¥ Pulling latest code..."
                      git pull origin main

                      # 3. å®‰è£…ä¾èµ–
                      echo "ğŸ“¦ Checking dependencies..."
                      if [ -f "requirements.txt" ]; then
                          echo "Found requirements.txt, installing..."
                          pip install -r requirements.txt
                      elif [ -f "pyproject.toml" ]; then
                          echo "Found pyproject.toml, installing..."
                          pip install .
                      else
                          echo "âš ï¸ No dependency file found, skipping installation."
                      fi

                      # 4. é‡å¯æœåŠ¡
                      echo "ğŸ”„ Restarting application..."

                      # å‡è®¾ä½¿ç”¨ systemd ç®¡ç†æœåŠ¡ï¼ŒæœåŠ¡åä¸º fiobot
                      if systemctl list-units --full -all | grep -Fq "fiobot.service"; then
                          systemctl restart fiobot
                          echo "âœ… Systemd service 'fiobot' restarted."
                      else
                          echo "âš ï¸ Systemd service 'fiobot' not found."
                          
                          
                      fi

                      echo "ğŸ‰ Deployment completed successfully!"
