name: Deploy to Aliyun

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Copy files via SCP
              uses: appleboy/scp-action@master
              with:
                  host: ${{ secrets.ALIYUN_HOST }}
                  username: ${{ secrets.ALIYUN_USER }}
                  key: ${{ secrets.ALIYUN_KEY }}
                  source: "."
                  target: "/root/fiobot"
                  rm: false
                  strip_components: 0

            - name: Deploy using SSH
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.ALIYUN_HOST }}
                  username: ${{ secrets.ALIYUN_USER }}
                  key: ${{ secrets.ALIYUN_KEY }}
                  script: |
                      set -e
                      echo "ğŸš€ Starting deployment tasks..."

                      TARGET_DIR="/root/fiobot"
                      VENV_DIR="/root/venv"

                      cd $TARGET_DIR

                      echo "âœ… Code updated via SCP."

                      # 3. è®¾ç½®è™šæ‹Ÿç¯å¢ƒ (é€‚é…æ‚¨çš„æœåŠ¡å™¨é…ç½®)
                      echo "ğŸ Setting up virtual environment at $VENV_DIR..."
                      if [ ! -d "$VENV_DIR" ]; then
                          echo "Creating virtual environment..."
                          python3 -m venv $VENV_DIR
                      fi

                      # ä½¿ç”¨æŒ‡å®šè™šæ‹Ÿç¯å¢ƒä¸­çš„ pip
                      PIP_CMD="$VENV_DIR/bin/pip"

                      echo "ğŸ“¦ Checking dependencies..."
                      if [ -f "requirements.txt" ]; then
                          echo "Found requirements.txt, installing..."
                          $PIP_CMD install -r requirements.txt
                      elif [ -f "pyproject.toml" ]; then
                          echo "Found pyproject.toml, installing..."
                          $PIP_CMD install .
                      else
                          echo "âš ï¸ No dependency file found, skipping installation."
                      fi

                      # 4. é‡å¯æœåŠ¡
                      echo "ğŸ”„ Restarting application..."

                      if systemctl list-units --full -all | grep -Fq "fiobot.service"; then
                          systemctl restart fiobot
                          echo "âœ… Systemd service 'fiobot' restarted."
                      else
                          echo "âš ï¸ Systemd service 'fiobot' not found."
                      fi

                      echo "ğŸ‰ Deployment completed successfully!"
